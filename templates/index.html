<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantrax League Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0c10;
      --surface: #111318;
      --surface2: #1a1d24;
      --border: #2a2d36;
      --accent: #00e5a0;
      --accent2: #ff6b35;
      --text: #e8eaf0;
      --muted: #6b7080;
      --gold: #ffd166;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Full-height layout, no body scroll */
    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      font-weight: 300;
    }

    /* ── HEADER — fixed, never scrolls ── */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 56px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 1.25rem;
      gap: 1rem;
      z-index: 200;
    }

    .logo {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800;
      font-size: 1.15rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--accent);
      white-space: nowrap;
      flex-shrink: 0;
    }
    .logo-btn {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
    }

    nav {
      display: flex;
      gap: 0.2rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    nav::-webkit-scrollbar { display: none; }

    .nav-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 0.4rem 0.85rem;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .nav-btn:hover  { color: var(--text); background: var(--surface2); }
    .nav-btn.active { color: var(--accent); background: rgba(0,229,160,0.1); }

    /* ── SECTIONS — each fills viewport minus header, scrolls independently ── */
    .section {
      display: none;
      position: fixed;
      top: 56px; left: 0; right: 0; bottom: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .section.active { display: block; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* ── SECTION HEADER ── */
    .section-header {
      display: flex;
      align-items: baseline;
      gap: 1rem;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .section-sub {
      color: var(--muted);
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    /* ── CONTROLS ── */
    .controls {
      display: flex;
      gap: 0.65rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
      align-items: center;
    }

    select, button { font-family: 'Barlow', sans-serif; }

    select {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.45rem 0.9rem;
      border-radius: 4px;
      font-size: 0.88rem;
      cursor: pointer;
      outline: none;
    }
    select:focus { border-color: var(--accent); }

    .btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 0.45rem 1.1rem;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.82rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn:hover { background: #00ffb3; }
    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--border); }

    /* ── TABLES ── */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 1.25rem;
    }

    /* Horizontal scroll wrapper for tables on mobile */
    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 0.72rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 0.6rem 0.9rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
      min-width: 480px; /* forces horizontal scroll on mobile */
    }

    thead th {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      font-size: 0.68rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 0.55rem 0.85rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    thead th.num { text-align: right; }

    tbody tr {
      border-bottom: 1px solid rgba(42,45,54,0.5);
      transition: background 0.1s;
    }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }

    tbody td {
      padding: 0.6rem 0.85rem;
      font-weight: 400;
      white-space: nowrap;
    }
    tbody td.num {
      text-align: right;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      font-size: 0.92rem;
    }

    .rank {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      color: var(--muted);
      width: 2rem;
    }
    .rank-1   { color: var(--gold); }
    .rank-2   { color: var(--accent); }
    .rank-rel { color: var(--accent2); }

    .badge {
      display: inline-block;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.6rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 0.1rem 0.32rem;
      border-radius: 3px;
      margin-left: 0.35rem;
      vertical-align: middle;
    }
    .badge-gold  { background: rgba(255,209,102,0.15); color: var(--gold); }
    .badge-green { background: rgba(0,229,160,0.15);   color: var(--accent); }
    .badge-red   { background: rgba(255,107,53,0.15);  color: var(--accent2); }

    /* ── CUP SECTION LAYOUT ── */
    /* Cup section has sticky sub-header for tabs */
    #section-cup .container {
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    .cup-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      flex-shrink: 0;
      margin-bottom: 1.25rem;
    }
    .cup-tabs::-webkit-scrollbar { display: none; }

    .cup-tab {
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted);
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      font-size: 0.82rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 0.5rem 0.9rem;
      cursor: pointer;
      margin-bottom: -1px;
      transition: all 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .cup-tab:hover  { color: var(--text); }
    .cup-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .cup-round { display: none; }
    .cup-round.active { display: block; }

    /* ── MATCH CARDS ── */
    .match-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1.1rem;
      margin-bottom: 0.75rem;
    }

    /* Aggregate row — big, centred */
    .match-agg {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .match-team {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 1rem;
    }
    .match-team.home { text-align: right; }

    .match-score {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800;
      font-size: 1.4rem;
      color: var(--accent);
      text-align: center;
      min-width: 70px;
    }

    /* Leg rows — same 3-col grid as agg, smaller */
    .match-legs {
      border-top: 1px solid var(--border);
      padding-top: 0.65rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .match-leg-row {
      display: grid;
      grid-template-columns: 80px 1fr 80px;
      align-items: center;
      font-size: 0.82rem;
    }

    .leg-label {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 0.68rem;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: var(--muted);
      width: 80px;
      flex-shrink: 0;
    }

    .leg-spacer {
      width: 80px;
    }

    .leg-scores {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 70px 1fr;
      align-items: center;
    }

    .leg-home {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      text-align: right;
      color: var(--text);
    }

    .leg-dash {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      text-align: center;
      color: var(--muted);
    }

    .leg-away {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      text-align: left;
      color: var(--text);
    }

    .match-winner-label {
      text-align: center;
      margin-top: 0.65rem;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .draw-builder {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      max-width: 680px;
    }
    .draw-builder h3 {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }
    .draw-row {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.55rem;
    }
    .draw-vs {
      color: var(--muted);
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.72rem;
      text-align: center;
      width: 32px;
    }
    .draw-actions {
      margin-top: 0.8rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .team-link {
      background: none;
      border: none;
      color: inherit;
      font: inherit;
      padding: 0;
      cursor: pointer;
      text-align: inherit;
      text-decoration: underline;
      text-decoration-color: rgba(232,234,240,0.35);
      text-underline-offset: 2px;
    }
    .team-link:hover {
      color: var(--accent);
      text-decoration-color: var(--accent);
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(5, 7, 10, 0.78);
      z-index: 500;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal.active { display: flex; }
    .modal-card {
      width: min(960px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }
    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.9rem;
      padding-bottom: 0.7rem;
      border-bottom: 1px solid var(--border);
    }
    .profile-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.8rem;
    }
    @media (max-width: 860px) {
      .profile-grid { grid-template-columns: 1fr; }
    }
    .profile-block {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.8rem;
    }
    .profile-title {
      font-family: 'Barlow Condensed', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      font-size: 0.72rem;
      margin-bottom: 0.45rem;
    }
    .profile-row {
      display: flex;
      justify-content: space-between;
      gap: 0.7rem;
      font-size: 0.86rem;
      padding: 0.28rem 0;
      border-bottom: 1px solid rgba(42,45,54,0.45);
    }
    .profile-row:last-child { border-bottom: none; }
    .profile-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.85rem;
    }
    .profile-list-item {
      display: flex;
      justify-content: space-between;
      gap: 0.7rem;
      border-bottom: 1px solid rgba(42,45,54,0.45);
      padding-bottom: 0.3rem;
    }
    .profile-list-item:last-child { border-bottom: none; padding-bottom: 0; }
    .profile-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }
    .profile-link:hover { text-decoration: underline; }
    .teams-search {
      width: min(520px, 100%);
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.55rem 0.85rem;
      border-radius: 4px;
      font-size: 0.88rem;
      outline: none;
    }
    .teams-search:focus { border-color: var(--accent); }
    .teams-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    @media (max-width: 1100px) { .teams-grid { grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 900px)  { .teams-grid { grid-template-columns: 1fr; } }

    .rules-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      min-height: 260px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .rules-body {
      font-size: 0.94rem;
      line-height: 1.55;
      color: var(--text);
      white-space: normal;
      word-break: break-word;
    }
    .rules-body h1, .rules-body h2, .rules-body h3 {
      font-family: 'Barlow Condensed', sans-serif;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin: 1rem 0 0.55rem;
    }
    .rules-body ul, .rules-body ol {
      margin-left: 1.15rem;
      margin-bottom: 0.8rem;
    }
    .rules-body p { margin-bottom: 0.75rem; }
    .rules-body a { color: var(--accent); }
    .rules-body table {
      width: 100%;
      min-width: 0;
      table-layout: auto;
      margin-bottom: 1rem;
    }
    .rules-body th,
    .rules-body td {
      white-space: normal;
      word-break: break-word;
    }
    .rules-body table.rules-table-2col {
      table-layout: fixed;
    }
    .rules-body table.rules-table-2col th:nth-child(1),
    .rules-body table.rules-table-2col td:nth-child(1) {
      width: 82%;
    }
    .rules-body table.rules-table-2col th:nth-child(2),
    .rules-body table.rules-table-2col td:nth-child(2) {
      width: 18%;
      text-align: right;
    }
    .rules-editor {
      margin-top: 0.9rem;
      display: none;
    }
    .rules-editor.active { display: block; }
    .rules-textarea {
      width: 100%;
      min-height: 260px;
      resize: vertical;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.8rem;
      background: var(--surface2);
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.86rem;
      line-height: 1.4;
      outline: none;
    }
    .rules-textarea:focus { border-color: var(--accent); }
    .rules-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.65rem;
    }
    .rules-admin {
      display: flex;
      justify-content: flex-end;
      margin-top: 0.8rem;
    }
    .btn-discreet {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.68rem;
      letter-spacing: 0.1em;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .btn-discreet:hover {
      color: var(--text);
      border-color: #3a3e49;
      background: rgba(58,62,73,0.22);
    }

    /* ── MOTM BANNERS ── */
    .motm-banner {
      border-radius: 6px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }
    .motm-winner-card {
      background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(255,209,102,0.03));
      border: 1px solid rgba(255,209,102,0.3);
    }
    .motm-pending-card {
      background: rgba(107,112,128,0.08);
      border: 1px solid var(--border);
    }
    .motm-trophy   { font-size: 2.2rem; line-height: 1; flex-shrink: 0; }
    .motm-label    { font-size: 0.72rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.2rem; }
    .motm-name     { font-family: 'Barlow Condensed', sans-serif; font-weight: 800; font-size: 1.6rem; }
    .motm-name-won { color: var(--gold); }
    .motm-name-live { color: var(--accent); }
    .motm-name-none { color: var(--muted); font-size: 1.2rem; }
    .motm-detail   { font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 0.92rem; color: var(--text); margin-top: 0.2rem; }

    /* ── GROUPS GRID ── */
    .groups-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    @media (max-width: 1100px) { .groups-grid { grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 900px)  { .groups-grid { grid-template-columns: 1fr; } }

    .home-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    .home-block {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
    }
    .home-block-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 0.92rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 0.8rem;
    }
    .leaders-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.8rem;
    }
    .leader-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.8rem;
    }
    .leader-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.74rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    .leader-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .leader-row {
      display: grid;
      grid-template-columns: 24px 1fr auto auto;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    .leader-row.motm-row {
      grid-template-columns: 24px 1fr auto auto auto;
    }
    .leader-rank {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      color: var(--muted);
    }
    .leader-pts {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      color: var(--accent);
    }
    .leader-pf {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--text);
      white-space: nowrap;
    }
    .leader-record {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--muted);
      letter-spacing: 0.02em;
      white-space: nowrap;
    }
    .home-cup-list,
    .home-motm-grid,
    .home-gw-grid {
      display: grid;
      gap: 0.65rem;
    }
    .home-cup-list {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .home-cup-card,
    .home-motm-card,
    .home-gw-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
    }
    .home-cup-line {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 150px minmax(0, 1fr);
      align-items: center;
      gap: 0.5rem;
      font-size: 0.86rem;
    }
    .home-cup-score {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      color: var(--accent);
      font-size: 0.95rem;
      letter-spacing: 0.02em;
      white-space: nowrap;
      text-align: center;
    }
    .home-cup-team {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: block;
    }
    .home-cup-line .home-cup-team:first-child {
      text-align: right;
    }
    .home-cup-line .home-cup-team:last-child {
      text-align: left;
    }
    .home-cup-winner {
      margin-top: 0.35rem;
      text-align: center;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--gold);
    }
    .home-cup-winner.pending {
      color: var(--muted);
    }
    .home-motm-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .leader-badge {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.62rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border-radius: 999px;
      padding: 0.1rem 0.4rem;
      border: 1px solid var(--border);
      color: var(--muted);
      white-space: nowrap;
    }
    .leader-badge.winner {
      color: var(--gold);
      border-color: rgba(255, 209, 102, 0.5);
      background: rgba(255, 209, 102, 0.12);
    }
    .leader-badge.leader {
      color: var(--accent);
      border-color: rgba(0, 229, 160, 0.45);
      background: rgba(0, 229, 160, 0.1);
    }
    .home-motm-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    .home-motm-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.4rem;
    }
    .home-motm-league {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .home-motm-status {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.68rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .home-motm-team {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 1.05rem;
      margin-bottom: 0.2rem;
    }
    .home-motm-pts {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      color: var(--accent);
    }
    .home-gw-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    .home-gw-head {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    .home-gw-list {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .home-gw-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 150px minmax(0, 1fr);
      gap: 0.5rem;
      align-items: center;
      font-size: 0.84rem;
    }
    .home-gw-row .home-team-home,
    .home-gw-row .home-team-away {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: block;
    }
    .home-gw-row .home-team-home { text-align: right; }
    .home-gw-row .home-team-away { text-align: left; }
    .home-gw-score {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
      text-align: center;
    }
    @media (max-width: 1100px) {
      .leaders-grid,
      .home-motm-grid,
      .home-gw-grid {
        grid-template-columns: 1fr;
      }
      .home-cup-list {
        grid-template-columns: 1fr;
      }
    }

    /* ── STATES ── */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--muted);
      font-size: 0.88rem;
    }
    .loading::after {
      content: '';
      display: inline-block;
      width: 11px; height: 11px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 0.5rem;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .empty {
      text-align: center;
      padding: 3rem;
      color: var(--muted);
      font-size: 0.88rem;
    }

    .error {
      background: rgba(255,107,53,0.1);
      border: 1px solid rgba(255,107,53,0.3);
      color: var(--accent2);
      padding: 0.65rem 1rem;
      border-radius: 4px;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

<!-- Fixed top nav — never scrolls -->
<header>
  <button class="logo logo-btn" type="button" onclick="goHome()">⚽ FLM</button>
  <nav>
    <button class="nav-btn active" data-nav="home" onclick="showSection('home', this)">Home</button>
    <button class="nav-btn" data-nav="standings" onclick="showSection('standings', this)">Standings</button>
    <button class="nav-btn" data-nav="motm" onclick="showSection('motm', this)">MOTM</button>
    <button class="nav-btn" data-nav="cup" onclick="showSection('cup', this)">League Cup</button>
    <button class="nav-btn" data-nav="teams" onclick="showSection('teams', this)">Teams</button>
    <button class="nav-btn" data-nav="rules" onclick="showSection('rules', this)">Rules</button>
  </nav>
</header>

<!-- Each section fills the space below the header and scrolls independently -->
<div id="section-home" class="section active">
  <div class="container">
    <div class="section-header">
      <div class="section-title">Home</div>
      <div class="section-sub">At-a-glance dashboard</div>
    </div>
    <div class="home-grid">
      <div class="home-block">
        <div class="home-block-title">League Leaders</div>
        <div id="home-leaders-content"><div class="loading">Loading</div></div>
      </div>
      <div class="home-block">
        <div class="home-block-title">Manager Of The Month: <span id="home-motm-month">-</span></div>
        <div id="home-motm-content"><div class="loading">Loading</div></div>
      </div>
      <div class="home-block">
        <div class="home-block-title" id="home-cup-title">Latest Round</div>
        <div id="home-cup-content"><div class="loading">Loading</div></div>
      </div>
      <div class="home-block">
        <div class="home-block-title">Current Gameweek</div>
        <div id="home-gw-content"><div class="loading">Loading</div></div>
      </div>
    </div>
  </div>
</div>

<div id="section-standings" class="section">
  <div class="container">
    <div class="section-header">
      <div class="section-title">Standings</div>
      <div class="section-sub">2025–26 Season</div>
    </div>
    <div class="controls">
      <select id="standings-league" onchange="loadStandings()">
        <option value="premier_league">Premier League</option>
        <option value="championship">Championship</option>
        <option value="league_one">League One</option>
      </select>
    </div>
    <div id="standings-content"><div class="loading">Loading</div></div>
  </div>
</div>

<div id="section-motm" class="section">
  <div class="container">
    <div class="section-header">
      <div class="section-title">Manager of the Month</div>
      <div class="section-sub">Head-to-head points</div>
    </div>
    <div class="controls">
      <select id="motm-league" onchange="loadMOTM()">
        <option value="premier_league">Premier League</option>
        <option value="championship">Championship</option>
        <option value="league_one">League One</option>
      </select>
      <select id="motm-month" onchange="loadMOTM()">
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
        <option value="January">January</option>
        <option value="February" selected>February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
      </select>
    </div>
    <div id="motm-content"><div class="loading">Loading</div></div>
  </div>
</div>

<div id="section-cup" class="section">
  <div class="container">
    <div class="section-header">
      <div class="section-title">League Cup</div>
      <div class="section-sub">2025–26</div>
    </div>
    <div class="cup-tabs">
      <button class="cup-tab" data-round="groups"        onclick="showCupRound('groups',this)">Group Stage</button>
      <button class="cup-tab" data-round="playoff"       onclick="showCupRound('playoff',this)">Playoff</button>
      <button class="cup-tab" data-round="round_of_16"   onclick="showCupRound('round_of_16',this)">Round of 16</button>
      <button class="cup-tab" data-round="quarter_final" onclick="showCupRound('quarter_final',this)">Quarter Final</button>
      <button class="cup-tab" data-round="semi_final"    onclick="showCupRound('semi_final',this)">Semi Final</button>
      <button class="cup-tab" data-round="final"         onclick="showCupRound('final',this)">Final</button>
    </div>
    <div id="cup-groups"        class="cup-round"><div class="loading">Loading</div></div>
    <div id="cup-playoff"       class="cup-round"></div>
    <div id="cup-round_of_16"   class="cup-round"></div>
    <div id="cup-quarter_final" class="cup-round"></div>
    <div id="cup-semi_final"    class="cup-round"></div>
    <div id="cup-final"         class="cup-round"></div>
  </div>
</div>

<div id="section-teams" class="section">
  <div class="container">
    <div class="section-header">
      <div class="section-title">Teams</div>
      <div class="section-sub">Browse by league</div>
    </div>
    <div class="controls">
      <input id="teams-search" class="teams-search" type="text" placeholder="Search team name..." oninput="filterTeamsList()">
    </div>
    <div id="teams-content"><div class="loading">Loading</div></div>
  </div>
</div>

<div id="section-team-profile" class="section">
  <div class="container">
    <div class="section-header">
      <div>
        <div class="section-title" style="font-size:1.6rem" id="profile-title">Team Profile</div>
        <div class="section-sub" id="profile-subtitle"></div>
      </div>
      <button class="btn btn-secondary" onclick="goToTeams()">Back To Teams</button>
    </div>
    <div id="team-profile-content"><div class="loading">Loading</div></div>
  </div>
</div>

<div id="section-rules" class="section">
  <div class="container">
    <div class="section-header">
      <div class="section-title">Rules</div>
      <div class="section-sub">League rules and notes</div>
    </div>
    <div class="rules-wrap">
      <div id="rules-display" class="rules-body"><div class="loading">Loading</div></div>
      <div id="rules-editor-wrap" class="rules-editor">
        <textarea id="rules-editor" class="rules-textarea" placeholder="Write rules in markdown..."></textarea>
        <div class="rules-actions">
          <button class="btn btn-secondary" onclick="cancelRulesEdit()">Cancel</button>
          <button class="btn" onclick="saveRules()">Save Rules</button>
        </div>
      </div>
      <div id="rules-admin-area" class="rules-admin"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const LEAGUE_ORDER = ['premier_league', 'championship', 'league_one'];
  const LEAGUE_LABELS = {
    premier_league: 'Premier League',
    championship: 'Championship',
    league_one: 'League One'
  };
  const MOTM_MONTHS = [
    'August', 'September', 'October', 'November',
    'December', 'January', 'February', 'March', 'April', 'May'
  ];

  // ── MONTH END DATES ──────────────────────────────────────────────────────────
  const MONTH_END = {
    August:"2025-09-11", September:"2025-10-02", October:"2025-10-30",
    November:"2025-11-27", December:"2026-01-08", January:"2026-01-29",
    February:"2026-02-26", March:"2026-03-26", April:"2026-04-23", May:"2026-05-28"
  };

  function isMonthComplete(month) {
    return MONTH_END[month] ? new Date() > new Date(MONTH_END[month]) : false;
  }

  // ── NAVIGATION ───────────────────────────────────────────────────────────────
  function setNavActive(navKey) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if (!navKey) return;
    const btn = document.querySelector(`.nav-btn[data-nav="${navKey}"]`);
    if (btn) btn.classList.add('active');
  }

  function goHome() {
    showSection('home', document.querySelector('.nav-btn[data-nav="home"]'));
  }

  function goToTeams() {
    showSection('teams', document.querySelector('.nav-btn[data-nav="teams"]'));
  }

  function showSection(name, btn) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + name).classList.add('active');
    if (btn && btn.dataset.nav) setNavActive(btn.dataset.nav);
    if (name === 'home')      loadHome();
    if (name === 'standings') loadStandings();
    if (name === 'motm')      loadMOTM();
    if (name === 'cup') {
      drawAdminKeyByRound = {};
      initCup();
    }
    if (name === 'teams')     loadTeams();
    if (name === 'rules') {
      rulesAdminKey = '';
      loadRules();
    }
  }

  function formatRoundLabel(roundName) {
    const labels = {
      groups: 'Group Stage',
      playoff: 'Playoff',
      round_of_16: 'Round of 16',
      quarter_final: 'Quarter Final',
      semi_final: 'Semi Final',
      final: 'Final'
    };
    return labels[roundName] || (roundName || '').replaceAll('_', ' ');
  }

  function formatScore(value) {
    const n = Number(value);
    if (!Number.isFinite(n)) return '0';
    const fixed = n.toFixed(2);
    return fixed.endsWith('00') ? n.toFixed(0) : fixed.replace(/0$/, '');
  }

  function getCurrentMOTMMonth() {
    const nowMonth = new Date().toLocaleString('en-US', { month: 'long' });
    return MOTM_MONTHS.includes(nowMonth) ? nowMonth : 'May';
  }

  function teamLink(label, teamId) {
    if (!teamId) return label;
    return `<button class="team-link" onclick="openTeamProfile('${teamId}')">${label}</button>`;
  }

  function formatOrdinal(n) {
    const v = Number(n);
    if (!Number.isFinite(v)) return n;
    const mod100 = v % 100;
    if (mod100 >= 11 && mod100 <= 13) return `${v}th`;
    const mod10 = v % 10;
    if (mod10 === 1) return `${v}st`;
    if (mod10 === 2) return `${v}nd`;
    if (mod10 === 3) return `${v}rd`;
    return `${v}th`;
  }

  function escapeHtml(str) {
    return `${str}`
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function renderMarkdown(md) {
    if (window.marked && typeof window.marked.parse === 'function') {
      return window.marked.parse(md || '');
    }
    return `<p>${escapeHtml(md || '').replaceAll('\n', '<br>')}</p>`;
  }

  function normalizeRulesTables(rootEl) {
    if (!rootEl) return;
    const tables = rootEl.querySelectorAll('table');
    tables.forEach(table => {
      table.classList.remove('rules-table-2col');
      const headerCols = table.querySelectorAll('thead tr th').length;
      let cols = headerCols;
      if (!cols) {
        const firstRow = table.querySelector('tr');
        cols = firstRow ? firstRow.children.length : 0;
      }
      if (cols === 2) table.classList.add('rules-table-2col');
    });
  }

  function setRulesDisplay(markdownText) {
    const display = document.getElementById('rules-display');
    if (!display) return;
    display.innerHTML = markdownText.trim()
      ? renderMarkdown(markdownText)
      : '<div class="empty" style="padding:1rem 0">No rules added yet</div>';
    normalizeRulesTables(display);
  }

  // ── HOME ─────────────────────────────────────────────────────────────────────
  let homeLoaded = false;

  async function loadHome(force = false) {
    const leadersEl = document.getElementById('home-leaders-content');
    const cupTitleEl = document.getElementById('home-cup-title');
    const cupEl = document.getElementById('home-cup-content');
    const motmMonthEl = document.getElementById('home-motm-month');
    const motmEl = document.getElementById('home-motm-content');
    const gwEl = document.getElementById('home-gw-content');

    if (!leadersEl || !cupEl || !motmEl || !gwEl || !cupTitleEl || !motmMonthEl) return;
    if (homeLoaded && !force) return;

    leadersEl.innerHTML = '<div class="loading">Loading</div>';
    cupEl.innerHTML = '<div class="loading">Loading</div>';
    motmEl.innerHTML = '<div class="loading">Loading</div>';
    gwEl.innerHTML = '<div class="loading">Loading</div>';

    const month = getCurrentMOTMMonth();
    motmMonthEl.textContent = month;

    try {
      const standingsReqs = LEAGUE_ORDER.map(leagueKey =>
        fetch(`/api/standings/${leagueKey}`).then(r => r.json())
      );
      const motmReqs = LEAGUE_ORDER.map(leagueKey =>
        fetch(`/api/motm/${leagueKey}/${month}`).then(r => r.json())
      );
      const cupRoundReq = fetch('/api/cup/current_round').then(r => r.json());
      const gwReq = fetch('/api/gameweek/current').then(r => r.json());

      const [standingsJson, motmJson, cupRoundJson, gameweekJson] = await Promise.all([
        Promise.all(standingsReqs),
        Promise.all(motmReqs),
        cupRoundReq,
        gwReq
      ]);

      const standingsByLeague = {};
      standingsJson.forEach((json, idx) => {
        if (json.success) standingsByLeague[LEAGUE_ORDER[idx]] = json.data;
      });
      leadersEl.innerHTML = renderHomeLeaders(standingsByLeague);

      const motmByLeague = {};
      motmJson.forEach((json, idx) => {
        if (json.success) motmByLeague[LEAGUE_ORDER[idx]] = json.data;
      });
      motmEl.innerHTML = renderHomeMOTM(motmByLeague);

      if (gameweekJson.success) {
        gwEl.innerHTML = renderHomeGameweek(gameweekJson.data);
      } else {
        gwEl.innerHTML = `<div class="error">Error loading current gameweek: ${gameweekJson.error || 'Unknown error'}</div>`;
      }

      const roundName = cupRoundJson.success ? cupRoundJson.data : 'groups';
      cupTitleEl.textContent = `Latest Round: ${formatRoundLabel(roundName)}`;
      try {
        const roundRes = await fetch(`/api/cup/round/${roundName}`);
        const roundJson = await roundRes.json();
        if (!roundJson.success) throw new Error(roundJson.error || 'Failed to load round');
        cupEl.innerHTML = renderHomeCup(roundJson.data || []);
      } catch (e) {
        cupEl.innerHTML = `<div class="error">Error loading latest cup round: ${e.message}</div>`;
      }

      homeLoaded = true;
    } catch (e) {
      leadersEl.innerHTML = `<div class="error">Error loading league leaders: ${e.message}</div>`;
      motmEl.innerHTML = `<div class="error">Error loading MOTM: ${e.message}</div>`;
      cupEl.innerHTML = `<div class="error">Error loading cup round: ${e.message}</div>`;
      gwEl.innerHTML = `<div class="error">Error loading current gameweek: ${e.message}</div>`;
    }
  }

  function renderHomeLeaders(standingsByLeague) {
    const cards = LEAGUE_ORDER.map(leagueKey => {
      const rows = (standingsByLeague[leagueKey] || []).slice(0, 3);
      const body = rows.length
        ? rows.map(t => `
          <div class="leader-row">
            <span class="leader-rank">${t.rank}</span>
            <span>${teamLink(t.teamName, t.teamId)}</span>
            <span class="leader-record">W${t.w} D${t.d} L${t.l}</span>
            <span class="leader-pts">${t.pts}pts</span>
          </div>
        `).join('')
        : '<div class="empty" style="padding:0.8rem 0">No data</div>';
      return `
        <div class="leader-card">
          <div class="leader-title">${LEAGUE_LABELS[leagueKey]}</div>
          <div class="leader-list">${body}</div>
        </div>
      `;
    }).join('');
    return `<div class="leaders-grid">${cards}</div>`;
  }

  function renderHomeCup(matches) {
    if (!matches.length) {
      return '<div class="empty" style="padding:0.9rem 0">No matchups available yet</div>';
    }
    const cards = matches.map(m => {
      return `
        <div class="home-cup-card">
          <div class="home-cup-line">
            <span class="home-cup-team">${teamLink(m.home, m.home_id)}</span>
            <span class="home-cup-score">${formatScore(m.home_agg || 0)} - ${formatScore(m.away_agg || 0)}</span>
            <span class="home-cup-team">${teamLink(m.away, m.away_id)}</span>
          </div>
          <div class="home-cup-winner ${m.winner ? '' : 'pending'}">${m.winner ? 'Decided' : 'In progress'}</div>
        </div>
      `;
    }).join('');
    return `<div class="home-cup-list">${cards}</div>`;
  }

  function renderHomeMOTM(motmByLeague) {
    const cards = LEAGUE_ORDER.map(leagueKey => {
      const entry = motmByLeague[leagueKey];
      const played = entry ? entry.results.filter(r => (r.w + r.d + r.l) > 0) : [];
      if (!entry || !played.length) {
        return `
          <div class="home-motm-card">
            <div class="home-motm-head">
              <span class="home-motm-league">${LEAGUE_LABELS[leagueKey]}</span>
              <span class="home-motm-status">No games</span>
            </div>
            <div class="empty" style="padding:0.8rem 0">No games played yet</div>
          </div>
        `;
      }

      const status = entry.month_complete ? 'Winner' : 'Leader';
      const top3 = played.slice(0, 3);
      const rows = top3.map((r, idx) => `
        <div class="leader-row motm-row">
          <span class="leader-rank">${r.rank}</span>
          <span>${teamLink(r.team, r.teamId)}${idx === 0 ? ` <span class="leader-badge ${entry.month_complete ? 'winner' : 'leader'}">${status}</span>` : ''}</span>
          <span class="leader-record">W${r.w} D${r.d} L${r.l}</span>
          <span class="leader-pf">PF ${formatScore(r.pf)}</span>
          <span class="leader-pts">${r.pts}pts</span>
        </div>
      `).join('');

      return `
        <div class="home-motm-card">
          <div class="home-motm-head">
            <span class="home-motm-league">${LEAGUE_LABELS[leagueKey]}</span>
            <span class="home-motm-status">${entry.month_complete ? 'Complete' : 'In progress'}</span>
          </div>
          <div class="home-motm-list">${rows}</div>
        </div>
      `;
    }).join('');
    return `<div class="home-motm-grid">${cards}</div>`;
  }

  function renderHomeGameweek(gameweekByLeague) {
    const cards = LEAGUE_ORDER.map(leagueKey => {
      const data = gameweekByLeague[leagueKey];
      const gwLabel = data && data.gw ? `GW${data.gw}` : 'No completed GW';
      const matches = (data && data.matches) || [];
      const rows = matches.length
        ? matches.map(m => `
          <div class="home-gw-row">
            <span class="home-team-home">${m.home}</span>
            <span class="home-gw-score">${formatScore(m.home_score)} - ${formatScore(m.away_score)}</span>
            <span class="home-team-away">${m.away}</span>
          </div>
        `).join('')
        : '<div class="empty" style="padding:0.8rem 0">No completed fixtures</div>';

      return `
        <div class="home-gw-card">
          <div class="home-gw-head">${LEAGUE_LABELS[leagueKey]} · ${gwLabel}</div>
          <div class="home-gw-list">${rows}</div>
        </div>
      `;
    }).join('');
    return `<div class="home-gw-grid">${cards}</div>`;
  }

  // ── RULES ────────────────────────────────────────────────────────────────────
  let rulesAdminKey = '';
  let rulesMarkdown = '';

  async function loadRules() {
    const display = document.getElementById('rules-display');
    const editorWrap = document.getElementById('rules-editor-wrap');
    const adminArea = document.getElementById('rules-admin-area');
    if (!display || !editorWrap || !adminArea) return;

    display.innerHTML = '<div class="loading">Loading</div>';
    editorWrap.classList.remove('active');
    adminArea.innerHTML = '';
    try {
      const res = await fetch('/api/rules');
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Failed to load rules');
      rulesMarkdown = json.data.markdown || '';
      setRulesDisplay(rulesMarkdown);
      adminArea.innerHTML = '<button class="btn-discreet" onclick="unlockRulesAdmin(this)">Admin</button>';
    } catch (e) {
      display.innerHTML = `<div class="error">Error loading rules: ${e.message}</div>`;
    }
  }

  async function unlockRulesAdmin(btn) {
    const key = prompt('Enter admin key to edit rules');
    if (!key) return;
    try {
      const res = await fetch('/api/rules/auth', {
        headers: { 'X-Admin-Key': key }
      });
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Unauthorized');
      rulesAdminKey = key;
      if (btn) btn.remove();
      const editorWrap = document.getElementById('rules-editor-wrap');
      const textarea = document.getElementById('rules-editor');
      textarea.value = rulesMarkdown;
      editorWrap.classList.add('active');
      textarea.focus();
    } catch (e) {
      alert(`Admin access denied: ${e.message}`);
    }
  }

  function cancelRulesEdit() {
    rulesAdminKey = '';
    document.getElementById('rules-editor-wrap').classList.remove('active');
    document.getElementById('rules-admin-area').innerHTML = '<button class="btn-discreet" onclick="unlockRulesAdmin(this)">Admin</button>';
  }

  async function saveRules() {
    if (!rulesAdminKey) {
      alert('Admin key required');
      return;
    }
    const markdown = document.getElementById('rules-editor').value;
    try {
      const res = await fetch('/api/rules', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Key': rulesAdminKey
        },
        body: JSON.stringify({ markdown })
      });
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Failed to save');
      rulesMarkdown = markdown;
      setRulesDisplay(rulesMarkdown);
      document.getElementById('rules-editor-wrap').classList.remove('active');
      rulesAdminKey = '';
      document.getElementById('rules-admin-area').innerHTML = '<button class="btn-discreet" onclick="unlockRulesAdmin(this)">Admin</button>';
      alert('Rules saved');
    } catch (e) {
      alert(`Error saving rules: ${e.message}`);
    }
  }

  // ── TEAMS ────────────────────────────────────────────────────────────────────
  let teamsDirectoryData = null;

  async function loadTeams(force = false) {
    const el = document.getElementById('teams-content');
    if (!force && teamsDirectoryData) {
      renderTeamsDirectory();
      return;
    }
    el.innerHTML = '<div class="loading">Loading</div>';
    try {
      const res = await fetch('/api/teams');
      const json = await res.json();
      if (!json.success) throw new Error(json.error);
      teamsDirectoryData = json.data;
      renderTeamsDirectory();
    } catch (e) {
      el.innerHTML = `<div class="error">Error: ${e.message}</div>`;
    }
  }

  function filterTeamsList() {
    if (!teamsDirectoryData) return;
    renderTeamsDirectory();
  }

  function renderTeamsDirectory() {
    const el = document.getElementById('teams-content');
    if (!teamsDirectoryData) {
      el.innerHTML = '<div class="empty">No team data</div>';
      return;
    }
    const query = (document.getElementById('teams-search')?.value || '').trim().toLowerCase();
    const cards = LEAGUE_ORDER
      .filter(key => teamsDirectoryData[key])
      .map(key => teamsDirectoryData[key])
      .map(league => {
      const teams = league.teams.filter(t => !query || t.teamName.toLowerCase().includes(query));
      const rows = teams.map(t => `<tr>
        <td class="rank">${t.rank}</td>
        <td>${teamLink(t.teamName, t.teamId)}</td>
        <td class="num">${t.pts}</td>
      </tr>`).join('');
      const body = rows || '<tr><td colspan="3" class="empty" style="padding:1rem">No matching teams</td></tr>';
      return `<div class="table-wrap">
        <div class="table-title">${league.league_name}</div>
        <div class="table-scroll"><table>
          <thead><tr><th>#</th><th>Team</th><th class="num">Pts</th></tr></thead>
          <tbody>${body}</tbody>
        </table></div>
      </div>`;
    }).join('');
    el.innerHTML = `<div class="teams-grid">${cards}</div>`;
  }

  // ── STANDINGS ────────────────────────────────────────────────────────────────
  async function loadStandings() {
    const league = document.getElementById('standings-league').value;
    const el = document.getElementById('standings-content');
    el.innerHTML = '<div class="loading">Loading</div>';
    try {
      const res  = await fetch(`/api/standings/${league}`);
      const json = await res.json();
      if (!json.success) throw new Error(json.error);
      el.innerHTML = renderStandings(json.data, league);
    } catch(e) {
      el.innerHTML = `<div class="error">Error: ${e.message}</div>`;
    }
  }

  function renderStandings(data, leagueKey) {
    const rows = data.map(t => {
      let rankClass = '', badge = '';
      if (t.rank === 1) {
        rankClass = 'rank-1';
        badge = '<span class="badge badge-gold">Leader</span>';
      } else if (t.rank === 2 && leagueKey !== 'premier_league') {
        rankClass = 'rank-2';
        badge = '<span class="badge badge-green">Promotion</span>';
      } else if ((t.rank === 11 || t.rank === 12) && leagueKey !== 'league_one') {
        rankClass = 'rank-rel';
        badge = '<span class="badge badge-red">Relegation</span>';
      }
      const pd      = t.pd >= 0 ? `+${t.pd.toFixed(2)}` : t.pd.toFixed(2);
      const pdColor = t.pd >= 0 ? 'var(--accent)' : 'var(--accent2)';
      return `<tr>
        <td class="rank ${rankClass}">${t.rank}</td>
        <td>${teamLink(t.teamName, t.teamId)}${badge}</td>
        <td class="num">${t.w}</td>
        <td class="num">${t.d}</td>
        <td class="num">${t.l}</td>
        <td class="num">${t.pf.toFixed(2)}</td>
        <td class="num">${t.pa.toFixed(2)}</td>
        <td class="num" style="color:${pdColor}">${pd}</td>
        <td class="num" style="color:var(--accent);font-weight:700">${t.pts}</td>
      </tr>`;
    }).join('');

    return `<div class="table-wrap"><div class="table-scroll"><table>
      <thead><tr>
        <th>#</th><th>Team</th>
        <th class="num">W</th><th class="num">D</th><th class="num">L</th>
        <th class="num">PF</th><th class="num">PA</th>
        <th class="num">PD</th><th class="num">Pts</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table></div></div>`;
  }

  // ── MOTM ─────────────────────────────────────────────────────────────────────
  async function loadMOTM() {
    const league = document.getElementById('motm-league').value;
    const month  = document.getElementById('motm-month').value;
    const el     = document.getElementById('motm-content');
    el.innerHTML = '<div class="loading">Loading</div>';
    try {
      const res  = await fetch(`/api/motm/${league}/${month}`);
      const json = await res.json();
      if (!json.success) throw new Error(json.error);
      el.innerHTML = renderMOTM(json.data, month);
    } catch(e) {
      el.innerHTML = `<div class="error">Error: ${e.message}</div>`;
    }
  }

  function renderMOTM(data, month) {
    const complete = (typeof data.month_complete === 'boolean')
      ? data.month_complete
      : isMonthComplete(month);
    const played   = data.results.filter(r => (r.w + r.d + r.l) > 0);

    let banner = '';
    if (played.length === 0) {
      banner = `<div class="motm-banner motm-pending-card">
        <div class="motm-trophy">📅</div>
        <div>
          <div class="motm-label">${month} — Not Started</div>
          <div class="motm-name motm-name-none">No games played yet</div>
        </div>
      </div>`;
    } else if (complete) {
      const w = played[0];
      banner = `<div class="motm-banner motm-winner-card">
        <div class="motm-trophy">🏆</div>
        <div>
          <div class="motm-label">${month} Manager of the Month</div>
          <div class="motm-name motm-name-won">${w.team}</div>
          <div class="motm-detail">${w.pts} pts · ${w.w}W ${w.d}D ${w.l}L · ${w.pf.toFixed(2)} PF</div>
        </div>
      </div>`;
    } else {
      const l = played[0];
      banner = `<div class="motm-banner motm-pending-card">
        <div class="motm-trophy">📊</div>
        <div>
          <div class="motm-label">${month} — In Progress</div>
          <div class="motm-name motm-name-live">${l.team} leads</div>
          <div class="motm-detail">${l.pts} pts · ${l.w}W ${l.d}D ${l.l}L · Winner declared when month ends</div>
        </div>
      </div>`;
    }

    const rows = data.results.map(r => `<tr>
      <td class="rank ${r.rank===1?'rank-1':''}">${r.rank}</td>
      <td>${teamLink(r.team, r.teamId)}</td>
      <td class="num">${r.pts}</td>
      <td class="num">${r.w}</td>
      <td class="num">${r.d}</td>
      <td class="num">${r.l}</td>
      <td class="num">${r.pf.toFixed(2)}</td>
      <td class="num">${r.pa.toFixed(2)}</td>
    </tr>`).join('');

    return `${banner}
      <div class="table-wrap">
        <div class="table-title">Gameweeks: ${data.gameweeks.join(', ')}</div>
        <div class="table-scroll"><table>
          <thead><tr>
            <th>#</th><th>Team</th>
            <th class="num">Pts</th><th class="num">W</th><th class="num">D</th><th class="num">L</th>
            <th class="num">PF</th><th class="num">PA</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table></div>
      </div>`;
  }

  // ── CUP ──────────────────────────────────────────────────────────────────────
  let cupInitialised = false;
  const DRAW_ENABLED_ROUNDS = new Set(['quarter_final', 'semi_final', 'final']);
  const DRAW_TEAMS_BY_ROUND = {};
  let drawAdminKeyByRound = {};

  function getAdminHeaders(round) {
    const key = drawAdminKeyByRound[round] || '';
    return key ? { 'X-Admin-Key': key } : {};
  }

  async function unlockDrawAdmin(round, triggerBtn = null) {
    const key = prompt('Enter admin key to manage cup draws');
    if (!key) return;

    try {
      const res = await fetch(`/api/cup/draw/options/${round}`, {
        headers: { 'X-Admin-Key': key }
      });
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Admin check failed');
      drawAdminKeyByRound[round] = key;
      if (triggerBtn) {
        const wrap = triggerBtn.closest('.draw-unlock');
        if (wrap) wrap.remove();
      }
      openDrawBuilder(round);
    } catch (e) {
      alert(`Admin access denied: ${e.message}`);
    }
  }

  async function initCup() {
    if (cupInitialised) return;
    cupInitialised = true;
    try {
      const res  = await fetch('/api/cup/current_round');
      const json = await res.json();
      const round = json.success ? json.data : 'groups';
      activateCupTab(round);
      if (round === 'groups') loadCupGroups();
      else loadCupRound(round);
    } catch(e) {
      activateCupTab('groups');
      loadCupGroups();
    }
  }

  function activateCupTab(round) {
    document.querySelectorAll('.cup-tab').forEach(t => {
      t.classList.toggle('active', t.dataset.round === round);
    });
    document.querySelectorAll('.cup-round').forEach(r => r.classList.remove('active'));
    document.getElementById('cup-' + round).classList.add('active');
  }

  function showCupRound(round, btn) {
    activateCupTab(round);
    if (round === 'groups') loadCupGroups();
    else loadCupRound(round);
  }

  async function loadCupGroups() {
    const el = document.getElementById('cup-groups');
    if (el.dataset.loaded) return;
    el.innerHTML = '<div class="loading">Loading</div>';
    try {
      const res  = await fetch('/api/cup/groups');
      const json = await res.json();
      if (!json.success) throw new Error(json.error);
      el.innerHTML = renderGroups(json.data);
      el.dataset.loaded = '1';
    } catch(e) {
      el.innerHTML = `<div class="error">Error: ${e.message}</div>`;
    }
  }

  function renderGroups(groups) {
    const topWinnerIds = new Set(
      Object.values(groups)
        .map(teams => teams.find(t => t.rank === 1))
        .filter(Boolean)
        .sort((a, b) => (b.pts - a.pts) || (b.pf - a.pf))
        .slice(0, 8)
        .map(t => t.id)
    );

    const cards = Object.entries(groups).map(([name, teams]) => {
      const rows = teams.map(t => {
        let rankClass = '', badge = '';
        if (t.rank === 1 && topWinnerIds.has(t.id)) {
          rankClass = 'rank-1';
          badge = '<span class="badge badge-gold">R16</span>';
        } else if (t.rank === 1 || t.rank === 2) {
          rankClass = 'rank-2';
          badge = '<span class="badge badge-green">PO</span>';
        }
        return `<tr>
          <td class="rank ${rankClass}">${t.rank}</td>
          <td>${teamLink(t.name, t.id)}${badge}</td>
          <td class="num">${t.pts}</td>
          <td class="num">${t.w}</td>
          <td class="num">${t.d}</td>
          <td class="num">${t.l}</td>
          <td class="num">${t.pf.toFixed(1)}</td>
        </tr>`;
      }).join('');
      return `<div class="table-wrap">
        <div class="table-title">Group ${name}</div>
        <div class="table-scroll"><table>
          <thead><tr>
            <th>#</th><th>Team</th>
            <th class="num">Pts</th><th class="num">W</th><th class="num">D</th><th class="num">L</th>
            <th class="num">PF</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table></div>
      </div>`;
    }).join('');
    return `<div class="groups-grid">${cards}</div>`;
  }

  async function loadCupRound(round) {
    const el = document.getElementById('cup-' + round);
    if (el.dataset.loaded) return;
    el.innerHTML = '<div class="loading">Loading</div>';
    try {
      const res  = await fetch(`/api/cup/round/${round}`);
      const json = await res.json();
      if (!json.success) throw new Error(json.error);
      if (!json.data.length) {
        const drawUi = DRAW_ENABLED_ROUNDS.has(round)
          ? `<div class="draw-unlock" style="display:flex;justify-content:center;margin-top:0.75rem">
               <button class="btn" onclick="unlockDrawAdmin('${round}', this)">Admin Unlock</button>
             </div>
             <div id="draw-builder-${round}" style="margin-top:0.75rem"></div>`
          : '';
        el.innerHTML = `<div class="empty">No matches drawn yet</div>${drawUi}`;
        return;
      }
      el.innerHTML = renderCupRound(json.data, round);
      el.dataset.loaded = '1';
    } catch(e) {
      el.innerHTML = `<div class="error">Error: ${e.message}</div>`;
    }
  }

  function renderCupRound(matches, round) {
    const cards = matches.map(m => {
      const homeWin = m.winner === m.home;
      const awayWin = m.winner === m.away;
      const l1h = m.leg1_home !== null ? m.leg1_home : '–';
      const l1a = m.leg1_away !== null ? m.leg1_away : '–';
      const l2h = m.leg2_home !== null ? m.leg2_home : '–';
      const l2a = m.leg2_away !== null ? m.leg2_away : '–';

      return `<div class="match-card">
        <div class="match-agg">
          <div class="match-team home" style="${homeWin?'color:var(--gold)':''}">${teamLink(m.home, m.home_id)}</div>
          <div class="match-score">${m.home_agg ?? 0} – ${m.away_agg ?? 0}</div>
          <div class="match-team" style="${awayWin?'color:var(--gold)':''}">${teamLink(m.away, m.away_id)}</div>
        </div>
        <div class="match-leg-row">
          <span class="leg-label">GW${m.leg1_gw} · Leg 1</span>
          <div class="leg-scores">
            <span class="leg-home">${l1h}</span>
            <span class="leg-dash">–</span>
            <span class="leg-away">${l1a}</span>
          </div>
          <span class="leg-spacer" aria-hidden="true"></span>
        </div>
        <div class="match-leg-row">
          <span class="leg-label">GW${m.leg2_gw} · Leg 2</span>
          <div class="leg-scores">
            <span class="leg-home">${l2h}</span>
            <span class="leg-dash">–</span>
            <span class="leg-away">${l2a}</span>
          </div>
          <span class="leg-spacer" aria-hidden="true"></span>
        </div>
        ${m.winner
          ? `<div class="match-winner-label" style="color:var(--gold)">⚡ ${teamLink(m.winner, m.winner_id)} advances</div>`
          : `<div class="match-winner-label" style="color:var(--muted)">In progress</div>`}
      </div>`;
    }).join('');

    return `<div style="max-width:680px">
      <div style="display:flex;justify-content:flex-end;margin-bottom:1rem">
        <button class="btn btn-secondary" onclick="refreshCupRound('${round}')">↻ Refresh Scores</button>
      </div>
      ${cards}
    </div>`;
  }

  async function renderDrawBuilder(round) {
    try {
      const res = await fetch(`/api/cup/draw/options/${round}`, { headers: getAdminHeaders(round) });
      const json = await res.json();
      if (!json.success) throw new Error(json.error);
      const teams = json.data.teams || [];
      if (teams.length < 2) return '<div class="empty">No advanced teams available yet</div>';
      if (teams.length % 2 !== 0) return '<div class="error">Advanced team count is invalid for draw creation</div>';

      DRAW_TEAMS_BY_ROUND[round] = teams;
      const opts = teams
        .map(t => `<option value="${t.id}">${t.name}</option>`)
        .join('');
      const pairCount = teams.length / 2;
      const rows = Array.from({ length: pairCount }).map((_, i) => `
        <div class="draw-row">
          <select id="draw-${round}-home-${i}" onchange="updateDrawOptions('${round}', ${pairCount})">
            <option value="">Home team</option>
            ${opts}
          </select>
          <div class="draw-vs">vs</div>
          <select id="draw-${round}-away-${i}" onchange="updateDrawOptions('${round}', ${pairCount})">
            <option value="">Away team</option>
            ${opts}
          </select>
        </div>
      `).join('');

      return `
        <div class="draw-builder">
          <h3>Create ${round.replaceAll('_', ' ')}</h3>
          ${rows}
          <div class="draw-actions">
            <button class="btn" onclick="saveDraw('${round}', ${pairCount})">Save Draw</button>
          </div>
        </div>
      `;
    } catch (e) {
      if (`${e.message}`.toLowerCase().includes('unauthorized')) {
        return `<div class="error">Admin access required to create draws</div>`;
      }
      return `<div class="error">Error loading draw options: ${e.message}</div>`;
    }
  }

  async function openDrawBuilder(round) {
    const mount = document.getElementById(`draw-builder-${round}`);
    if (!mount) return;
    mount.innerHTML = '<div class="loading">Loading</div>';
    const html = await renderDrawBuilder(round);
    mount.innerHTML = html;
    const teams = DRAW_TEAMS_BY_ROUND[round] || [];
    if (teams.length >= 2) updateDrawOptions(round, teams.length / 2);
  }

  function updateDrawOptions(round, pairCount) {
    const teams = DRAW_TEAMS_BY_ROUND[round] || [];
    if (!teams.length) return;

    const selected = new Set();
    for (let i = 0; i < pairCount; i++) {
      const home = document.getElementById(`draw-${round}-home-${i}`)?.value;
      const away = document.getElementById(`draw-${round}-away-${i}`)?.value;
      if (home) selected.add(home);
      if (away) selected.add(away);
    }

    for (let i = 0; i < pairCount; i++) {
      const ids = [
        `draw-${round}-home-${i}`,
        `draw-${round}-away-${i}`
      ];
      for (const id of ids) {
        const select = document.getElementById(id);
        if (!select) continue;
        const current = select.value;
        const placeholder = id.includes('-home-') ? 'Home team' : 'Away team';
        const options = teams
          .filter(t => t.id === current || !selected.has(t.id))
          .map(t => `<option value="${t.id}">${t.name}</option>`)
          .join('');
        select.innerHTML = `<option value="">${placeholder}</option>${options}`;
        select.value = current;
      }
    }
  }

  async function saveDraw(round, pairCount) {
    const matches = [];
    const used = new Set();

    for (let i = 0; i < pairCount; i++) {
      const home = document.getElementById(`draw-${round}-home-${i}`).value;
      const away = document.getElementById(`draw-${round}-away-${i}`).value;
      if (!home || !away) {
        alert('Please select all teams before saving the draw.');
        return;
      }
      if (home === away) {
        alert('A team cannot be drawn against itself.');
        return;
      }
      if (used.has(home) || used.has(away)) {
        alert('Each team can only appear once in the draw.');
        return;
      }
      used.add(home);
      used.add(away);
      matches.push({ home, away });
    }

    try {
      const res = await fetch(`/api/cup/draw/${round}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...getAdminHeaders(round) },
        body: JSON.stringify({ matches })
      });
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Failed to save draw');
      alert('Draw saved');
      const el = document.getElementById('cup-' + round);
      delete el.dataset.loaded;
      loadCupRound(round);
    } catch (e) {
      alert(`Error saving draw: ${e.message}`);
    }
  }

  async function refreshCupRound(round) {
    const el = document.getElementById('cup-' + round);
    delete el.dataset.loaded;
    await fetch(`/api/cup/refresh/${round}`, { method: 'POST' });
    loadCupRound(round);
  }

  function fixtureLine(f) {
    const venue = f.is_home ? 'vs' : '@';
    const opp = f.opponent_rank ? `${f.opponent} (${formatOrdinal(f.opponent_rank)})` : f.opponent;
    if (!f.played) return `GW${f.gw} · ${venue} ${opp}`;
    return `GW${f.gw} · ${f.result} ${f.team_score}-${f.opp_score} ${venue} ${opp}`;
  }

  async function openTeamProfile(teamId) {
    const content = document.getElementById('team-profile-content');
    const title = document.getElementById('profile-title');
    const subtitle = document.getElementById('profile-subtitle');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-team-profile').classList.add('active');
    setNavActive('teams');
    content.innerHTML = '<div class="loading">Loading</div>';
    title.textContent = 'Team Profile';
    subtitle.textContent = '';

    try {
      const res = await fetch(`/api/team/profile/${teamId}`);
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Failed to load profile');
      const p = json.data;
      title.textContent = p.team.name;
      subtitle.textContent = `${p.team.league_name} · ${formatOrdinal(p.league.rank)}`;

      const last5 = p.fixtures.last5.length
        ? p.fixtures.last5.map(f => `<div class="profile-list-item"><span>${fixtureLine(f)}</span></div>`).join('')
        : '<div class="empty" style="padding:0.8rem 0">No results yet</div>';
      const next5 = p.fixtures.next5.length
        ? p.fixtures.next5.map(f => `<div class="profile-list-item"><span>${fixtureLine(f)}</span></div>`).join('')
        : '<div class="empty" style="padding:0.8rem 0">No upcoming fixtures</div>';
      const motmAwards = p.motm.awards.length
        ? p.motm.awards.map(a => `<div class="profile-list-item"><span>${a.month}</span><span>${a.league}</span></div>`).join('')
        : '<div class="empty" style="padding:0.8rem 0">No MOTM awards</div>';
      const fantraxLink = p.team.fantrax_url
        ? `<a class="profile-link" href="${p.team.fantrax_url}" target="_blank" rel="noopener noreferrer">Open public Fantrax page</a>`
        : '<span class="empty" style="padding:0.8rem 0">Fantrax link unavailable</span>';

      content.innerHTML = `
        <div class="profile-grid">
          <div class="profile-block">
            <div class="profile-title">League Snapshot</div>
            <div class="profile-row"><span>Position</span><span>${formatOrdinal(p.league.rank)}</span></div>
            <div class="profile-row"><span>Played</span><span>${p.league.played}</span></div>
            <div class="profile-row"><span>Total Points Scored</span><span>${p.league.pf.toFixed(2)}</span></div>
            <div class="profile-row"><span>Average PPG</span><span>${p.league.avg_ppg.toFixed(2)}</span></div>
            <div class="profile-row"><span>Cup Progress</span><span>${p.cup.progress}</span></div>
          </div>
          <div class="profile-block">
            <div class="profile-title">Manager Of The Month</div>
            <div class="profile-row"><span>Total Awards</span><span>${p.motm.count}</span></div>
            <div class="profile-list">${motmAwards}</div>
          </div>
          <div class="profile-block">
            <div class="profile-title">Last 5 Results</div>
            <div class="profile-list">${last5}</div>
          </div>
          <div class="profile-block">
            <div class="profile-title">Next 5 Fixtures</div>
            <div class="profile-list">${next5}</div>
          </div>
          <div class="profile-block" style="grid-column:1 / -1">
            <div class="profile-title">Links</div>
            ${fantraxLink}
          </div>
        </div>
      `;
    } catch (e) {
      content.innerHTML = `<div class="error">Error loading profile: ${e.message}</div>`;
    }
  }

  // ── INIT ─────────────────────────────────────────────────────────────────────
  loadHome();
</script>
</body>
</html>
